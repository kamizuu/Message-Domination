<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h1 id="heading">Message Domination</h1>

<!-- ðŸ”” Notification Prompt -->
<div id="notifyBox" class="input-container" style="display:none;">
  <p>Enable notifications for Direct Messages?</p>
  <button onclick="enableNotifications()">Enable Notifications</button>
</div>

<!-- LOGIN -->
<div id="loginBox" class="input-container">
  <h2>Login / Sign Up</h2>
  <input type="text" id="loginUsername" placeholder="Username">
  <input type="password" id="loginPassword" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="appBox" style="display:none;">
  <h2>Welcome!</h2>
  <p>You are logged in as <strong id="currentUser"></strong></p>

  <div class="input-container">
    <input type="text" id="targetInput" placeholder="To (optional)">
    <input type="text" id="messageInput" placeholder="Message (required)">
    <button onclick="storeMessage()">Submit</button>
  </div>

  <h3 class="section-title">Latest Public Message</h3>
  <p id="displayMessage"></p>

  <h3 class="section-title">Direct Messages</h3>
  <div id="dmBox"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOQpcD2aZfk4se0p4dflESM-Af6p165tM",
  authDomain: "message-domination.firebaseapp.com",
  databaseURL: "https://message-domination-default-rtdb.firebaseio.com",
  projectId: "message-domination",
  storageBucket: "message-domination.firebasestorage.app",
  messagingSenderId: "517052643118",
  appId: "1:517052643118:web:a32021ce8587bef39f2cbf"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUsername = null;
let lastDMTime = 0;

// ðŸ”” Enable notifications
function enableNotifications() {
  Notification.requestPermission().then(() => {
    document.getElementById("notifyBox").style.display = "none";
  });
}
window.enableNotifications = enableNotifications;

// ðŸ” Login / auto-signup
async function login() {
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value;
  if (!username || !password) return alert("Enter username and password");

  const email = `${username}@messagedom.local`;

  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (err) {
    if (err.code === "auth/user-not-found") {
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Account created successfully!");
      } catch (err2) {
        alert("Error creating account: " + err2.message);
        return;
      }
    } else if (err.code === "auth/wrong-password") {
      alert("Wrong password!");
      return;
    } else {
      alert("Login error: " + err.message);
      return;
    }
  }
}
window.login = login;

// ðŸ”„ Auth state
onAuthStateChanged(auth, (user) => {
  if (!user) return;

  currentUsername = user.email.split("@")[0];
  document.getElementById("currentUser").textContent = currentUsername;

  document.getElementById("loginBox").style.display = "none";
  document.getElementById("appBox").style.display = "block";

  if ("Notification" in window && Notification.permission === "default") {
    document.getElementById("notifyBox").style.display = "block";
  }

  listenPublic();
  listenDMs();
});

// âœ‰ï¸ Send message
function storeMessage() {
  const to = document.getElementById("targetInput").value.trim();
  const text = document.getElementById("messageInput").value.trim();
  if (!text) return;

  if (to) {
    push(ref(db, "messages/dms"), {
      from: currentUsername,
      to,
      text,
      timestamp: Date.now()
    });
  } else {
    set(ref(db, "messages/latest"), {
      from: currentUsername,
      text,
      timestamp: Date.now()
    });
  }

  document.getElementById("messageInput").value = "";
}
window.storeMessage = storeMessage;

// ðŸ”´ Public listener
function listenPublic() {
  onValue(ref(db, "messages/latest"), (snap) => {
    const d = snap.val();
    if (!d) return;
    document.getElementById("displayMessage").textContent = `${d.from}: ${d.text}`;
  });
}

// ðŸ”µ DM listener + notifications (fixed)
function listenDMs() {
  onValue(ref(db, "messages/dms"), (snap) => {
    const dmsObj = snap.val() || {};
    const box = document.getElementById("dmBox");

    // Filter DMs for this user
    const userDMs = Object.values(dmsObj)
      .filter(dm => dm.from === currentUsername || dm.to === currentUsername)
      .sort((a, b) => b.timestamp - a.timestamp);

    // Fire notifications for new incoming DMs
    userDMs.forEach(dm => {
      if (dm.to === currentUsername && dm.timestamp > lastDMTime &&
          Notification.permission === "granted") {
        new Notification("New DM", { body: `${dm.from}: ${dm.text}` });
      }
    });

    // Update lastDMTime
    if (userDMs.length > 0) {
      lastDMTime = Math.max(lastDMTime, userDMs[0].timestamp);
    }

    // Render messages
    box.innerHTML = "";
    userDMs.forEach(dm => {
      const div = document.createElement("div");
      div.className = "dm-message";
      div.textContent = `${dm.from} âžœ ${dm.to}: ${dm.text}`;
      box.appendChild(div);
    });
  });
}
</script>

</body>
</html>
