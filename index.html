<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h1 id="heading">Message Domination</h1>

<!-- üîî Notifications -->
<div id="notifyBox" class="input-container" style="display:none;">
  <p>Enable notifications for Direct Messages?</p>
  <button onclick="enableNotifications()">Enable Notifications</button>
</div>

<!-- üîê AUTH -->
<div id="loginBox" class="input-container">
  <h2 id="authTitle">Login</h2>
  <input type="text" id="loginUsername" placeholder="Username">
  <input type="password" id="loginPassword" placeholder="Password (6+ chars)">
  <button onclick="handleAuth()">Continue</button>
  <p>
    <a href="#" onclick="toggleAuth()">Switch to <span id="authSwitch">Sign Up</span></a>
  </p>
</div>

<!-- üì¶ APP -->
<div id="appBox" style="display:none;">
  <h2>Welcome, <span id="currentUser"></span></h2>

  <div class="input-container">
    <input type="text" id="targetInput" placeholder="DM user (optional)">
    <input type="text" id="messageInput" placeholder="Message (required)">
    <button onclick="storeMessage()">Send</button>
  </div>

  <h3 class="section-title">Latest Public Message</h3>
  <p id="displayMessage"></p>

  <h3 class="section-title">Direct Messages</h3>
  <div id="dmBox"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

/* üîß Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCOQpcD2aZfk4se0p4dflESM-Af6p165tM",
  authDomain: "message-domination.firebaseapp.com",
  databaseURL: "https://message-domination-default-rtdb.firebaseio.com",
  projectId: "message-domination",
  storageBucket: "message-domination.firebasestorage.app",
  messagingSenderId: "517052643118",
  appId: "1:517052643118:web:a32021ce8587bef39f2cbf"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* üîê Auth */
let isSignup = false;
let currentUsername = null;

/* üì® DM state */
let cachedDMs = [];
let latestSeenDM = 0;

/* üîî Notifications */
function enableNotifications() {
  Notification.requestPermission().then(() => {
    document.getElementById("notifyBox").style.display = "none";
  });
}
window.enableNotifications = enableNotifications;

/* üîÅ Toggle auth mode */
function toggleAuth() {
  isSignup = !isSignup;
  document.getElementById("authTitle").textContent = isSignup ? "Sign Up" : "Login";
  document.getElementById("authSwitch").textContent = isSignup ? "Login" : "Sign Up";
}
window.toggleAuth = toggleAuth;

/* üîê Login / Signup */
async function handleAuth() {
  const username = document.getElementById("loginUsername").value.trim().toLowerCase();
  const password = document.getElementById("loginPassword").value;

  if (!username || !password) return alert("Enter username and password");
  if (password.length < 6) return alert("Password must be at least 6 characters");

  const email = `${username}@messagedom.com`;

  try {
    if (isSignup) {
      await createUserWithEmailAndPassword(auth, email, password);
      alert("Account created!");
    } else {
      await signInWithEmailAndPassword(auth, email, password);
    }
  } catch {
    alert("Username or password is wrong. Try creating a new account.");
  }
}
window.handleAuth = handleAuth;

/* üîÑ Auth state */
onAuthStateChanged(auth, (user) => {
  if (!user) return;

  currentUsername = user.email.split("@")[0];
  document.getElementById("currentUser").textContent = currentUsername;

  document.getElementById("loginBox").style.display = "none";
  document.getElementById("appBox").style.display = "block";

  if ("Notification" in window && Notification.permission === "default") {
    document.getElementById("notifyBox").style.display = "block";
  }

  listenPublic();
  listenDMs();
});

/* ‚úâÔ∏è Send message */
function storeMessage() {
  const to = document.getElementById("targetInput").value.trim().toLowerCase();
  const text = document.getElementById("messageInput").value.trim();
  if (!text) return;

  if (to) {
    push(ref(db, "messages/dms"), {
      from: currentUsername,
      to,
      text,
      timestamp: Date.now()
    });
  } else {
    set(ref(db, "messages/latest"), {
      from: currentUsername,
      text,
      timestamp: Date.now()
    });
  }

  document.getElementById("messageInput").value = "";
}
window.storeMessage = storeMessage;

/* üî¥ Public */
function listenPublic() {
  onValue(ref(db, "messages/latest"), (snap) => {
    const d = snap.val();
    if (!d) return;
    document.getElementById("displayMessage").textContent = `${d.from}: ${d.text}`;
  });
}

/* üîµ DMs ‚Äî FIXED */
function listenDMs() {
  onValue(ref(db, "messages/dms"), (snap) => {

    // üî• Critical mobile fix
    if (!currentUsername) return;

    const raw = snap.val();
    if (!raw) return;

    const userDMs = Object.values(raw)
      .filter(dm => dm.from === currentUsername || dm.to === currentUsername)
      .sort((a, b) => b.timestamp - a.timestamp);

    // üîî Notifications (desktop-safe)
    userDMs.forEach(dm => {
      if (
        dm.to === currentUsername &&
        dm.timestamp > latestSeenDM &&
        Notification.permission === "granted"
      ) {
        new Notification("New DM", {
          body: `${dm.from}: ${dm.text}`
        });
      }
    });

    if (userDMs.length > 0) {
      latestSeenDM = Math.max(...userDMs.map(dm => dm.timestamp));
    }

    // Avoid useless re-render
    if (JSON.stringify(userDMs) === JSON.stringify(cachedDMs)) return;
    cachedDMs = userDMs;

    const box = document.getElementById("dmBox");
    box.innerHTML = "";

    userDMs.forEach(dm => {
      const div = document.createElement("div");
      div.className = "dm-message";
      div.textContent = `${dm.from} ‚ûú ${dm.to}: ${dm.text}`;
      box.appendChild(div);
    });
  });
}
</script>

</body>
</html>
